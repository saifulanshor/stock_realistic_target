<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kalkulator Target Realistis Saham</title>

<style>
:root{
  --bg:#0f172a;--card:#020617;--line:#1e293b;--txt:#e5e7eb;--muted:#94a3b8;
  --green:#22c55e;--yellow:#eab308;--red:#ef4444;--blue:#2563eb
}
*{box-sizing:border-box}
body{font-family:Arial;background:var(--bg);color:var(--txt);padding:24px}
.wrap{max-width:960px;margin:auto}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}

h1{font-size:22px;margin-bottom:12px}
h3{font-size:14px;margin-bottom:10px;color:#cbd5f5}
label{font-size:12px;margin-top:8px;display:block;color:#cbd5f5}

input{width:100%;padding:10px;margin-top:4px;border-radius:10px;border:1px solid var(--line);background:#020617;color:var(--txt)}

button{padding:10px;border-radius:10px;border:none;background:var(--blue);color:#fff;cursor:pointer}

.panels{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
.panel{border:1px solid var(--line);border-radius:14px;padding:14px}
.p-title{font-size:12px;color:var(--muted)}
.p-value{font-size:18px;font-weight:700}

.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;margin-top:6px}
.bull{background:#052e16;color:var(--green)}
.mid{background:#3a2e0b;color:var(--yellow)}
.bear{background:#3b0a0a;color:var(--red)}

.targets{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.target{border:1px solid var(--line);border-radius:16px;padding:14px}
.low{outline:2px solid rgba(234,179,8,.2)}
.high{outline:2px solid rgba(34,197,94,.2)}
.price{font-size:22px;font-weight:800;margin-top:4px}
.gain{font-size:13px;margin-top:6px;color:#cbd5f5}

small{font-size:11px;color:var(--muted)}

@media(max-width:800px){
  .grid,.targets,.panels{grid-template-columns:1fr}
}

.score{
  margin-top:14px;
  padding:16px;
  border-radius:16px;
  border:1px solid var(--line);
}
.score-value{
  font-size:28px;
  font-weight:800;
}
.score-good{color:#22c55e}
.score-mid{color:#eab308}
.score-bad{color:#ef4444}
.score-label{
  margin-top:6px;
  font-size:13px;
  color:#cbd5f5;
}
</style>
</head>

<body>
<div class="wrap">
<h1>üìä Target Realistis Saham</h1>

<div class="grid">
<!-- INPUT -->
<div class="card">
<h3>üßÆ Input Data</h3>

<label>Ticker Saham</label>
<input id="ticker" placeholder="BBRI" oninput="onTickerInput()">

<label>Kode Broker</label>
<input id="broker" placeholder="YU" oninput="autoCapitalizeBroker()">

<label>Harga Saat Ini</label>
<small id="statusHint">Masukkan ticker lalu ambil harga</small>
<div style="display:flex;gap:6px">
  <input id="currentPrice" type="number" style="flex:1" oninput="validateForm()">
  <button type="button" onclick="fetchPrice()">üîÑ Ambil</button>
</div>
<small id="priceNote"></small>

<label>Buy Average</label>
<input id="buyAvg" type="number" disabled oninput="validateForm()">

<label>Buy Lot</label>
<input id="buyLot" type="number" disabled oninput="validateForm()">

<label>Total Bid (lot)</label>
<input id="totalBid" type="number" disabled oninput="validateForm()">

<label>Total Offer (lot)</label>
<input id="totalOffer" type="number" disabled oninput="validateForm()">

<label>Jumlah Papan</label>
<input id="jumlahPapan" type="number" step="0.01" disabled oninput="validateForm()">

<label>Tick Size</label>
<input id="tick" disabled>

<button id="btnHitung" disabled style="margin-top:14px;width:100%" onclick="hitung()">Hitung Target</button>
</div>

<!-- OUTPUT -->
<div class="card">
<h3>üìà Output</h3>
<div id="summary"></div>
<div id="bandarScore"></div>
<div id="targets"></div>
</div>
</div>
</div>

<script>
// ===== FETCH HARGA (Yahoo Finance) =====
async function fetchPrice(){
  const ticker = document.getElementById('ticker').value.toUpperCase();
  const res = await fetch(
    `https://yahoo-proxy.saifulanshor48.workers.dev/?symbol=${ticker}`
  );
  const data = await res.json();

  document.getElementById('currentPrice').value = data.close;
  document.getElementById('priceNote').innerText =
    'Harga closing hari bursa terakhir (via Yahoo! Finance)';
  
  document.getElementById('statusHint').innerText =
    'Harga diambil, lengkapi data lalu hitung target';
  
    enableInputs();
}

function enableInputs(){
  ['buyAvg','buyLot','totalBid','totalOffer','jumlahPapan']
    .forEach(id => document.getElementById(id).disabled = false);
}

function autoCapitalizeBroker(){
  const el = document.getElementById('broker');
  el.value = el.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,2);
}

function validateForm(){
  const required = [
    'currentPrice','buyAvg','buyLot',
    'totalBid','totalOffer','jumlahPapan'
  ];

  const ok = required.every(id =>
    document.getElementById(id).value
  );

  document.getElementById('btnHitung').disabled = !ok;
}


async function hitungBandarScore(ticker){
  const res = await fetch(
    `https://yahoo-proxy.saifulanshor48.workers.dev/?symbol=${ticker}&mode=ohlc`
  );

  const data = await res.json();

  // === Data 20 hari ===
  const closes = data.close;
  const highs = data.high;
  const lows = data.low;
  const volumes = data.volume;

  const n = closes.length - 1;

  const close = closes[n];
  const high = highs[n];
  const low = lows[n];
  const volume = volumes[n];

  // === Average ===
  const avgVol = volumes.reduce((a,b)=>a+b,0)/volumes.length;
  const avgRange = highs.map((h,i)=>h-lows[i])
    .reduce((a,b)=>a+b,0)/highs.length;

  let score = 0;

  // 1Ô∏è‚É£ Volume besar
  if(volume > avgVol) score += 25;

  // 2Ô∏è‚É£ Close di atas midpoint
  if(close > (high+low)/2) score += 20;

  // 3Ô∏è‚É£ Range efisien
  if((high-low) < avgRange) score += 15;

  // 4Ô∏è‚É£ Higher close
  if(close >= closes[n-1]) score += 15;

  // 5Ô∏è‚É£ Tidak distribusi
  if(!((high-low) > avgRange*1.8 && volume > avgVol*1.5)) score += 25;

  // === Label ===
  let label, cls;
  if(score >= 70){ label="üü¢ Akumulasi Bandar"; cls="score-good"; }
  else if(score >= 40){ label="üü° Netral / Build-up"; cls="score-mid"; }
  else{ label="üî¥ Distribusi / Risiko"; cls="score-bad"; }

  document.getElementById("bandarScore").innerHTML = `
    <div class="score">
      <div class="p-title">Bandar Score</div>
      <div class="score-value ${cls}">${score}/100</div>
      <div class="score-label">${label}</div>
    </div>
  `;
}

let tickerTimer;

function onTickerInput(){
  clearTimeout(tickerTimer);

  const el = document.getElementById('ticker');
  el.value = el.value.toUpperCase();

  tickerTimer = setTimeout(()=>{
    resetOnTickerChange();
  }, 500); // reset setelah user berhenti ngetik
}


let lastTicker = '';

function resetOnTickerChange(){

const current = document.getElementById('ticker').value.toUpperCase();
  if (current === lastTicker) return;

  lastTicker = current;
  // ===== Reset input angka =====
  const fields = [
    'broker',
    'currentPrice',
    'buyAvg',
    'buyLot',
    'totalBid',
    'totalOffer',
    'jumlahPapan',
    'tick'
  ];

  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // ===== Reset output =====
  const summary = document.getElementById('summary');
  const targets = document.getElementById('targets');
  const bandar = document.getElementById('bandarScore');
  const note = document.getElementById('priceNote');

  if (summary) summary.innerHTML = '';
  if (targets) targets.innerHTML = '';
  if (bandar) bandar.innerHTML = '';
  if (note) note.innerText = '';

  // ===== Optional: console log (debug) =====
  console.log('Data di-reset karena ticker berubah');
}


// ===== HITUNG TARGET =====
function hitung(){
  const ticker = document.getElementById('ticker').value || '-';
  const broker = document.getElementById('broker').value || '-';
  const current = Number(document.getElementById('currentPrice').value);
  const buyAvg = Number(document.getElementById('buyAvg').value);
  const buyLot = Number(document.getElementById('buyLot').value);
  const bid = Number(document.getElementById('totalBid').value);
  const offer = Number(document.getElementById('totalOffer').value);
  const papan = Number(document.getElementById('jumlahPapan').value);

  if(!current||!buyAvg||!buyLot||!bid||!offer||!papan){
    alert('Lengkapi semua input');
    return;
  }

  let tick;
  if(buyAvg<200) tick=1;
  else if(buyAvg<500) tick=2;
  else if(buyAvg<1000) tick=5;
  else if(buyAvg<5000) tick=10;
  else tick=25;

  document.getElementById('tick').value = tick;

  const ratio = bid/offer;
  let lowPct,highPct,badge,label;

  if(ratio>=2.5){lowPct=.39;highPct=.78;badge='bull';label='Bullish'}
  else if(ratio>=1.2){lowPct=.20;highPct=.33;badge='mid';label='Cukup Kuat'}
  else if(ratio>=.8){lowPct=.16;highPct=.33;badge='mid';label='Seimbang'}
  else{lowPct=.10;highPct=.21;badge='bear';label='Supply Dominan'}

  const baseline = buyAvg*0.05;
  const targetLow = buyAvg+baseline+(papan*lowPct*tick);
  const targetHigh = buyAvg+baseline+(papan*highPct*tick);

  const gainLow = targetLow-current;
  const gainHigh = targetHigh-current;

  document.getElementById('summary').innerHTML = `
  <div class="panels">
    <div class="panel"><div class="p-title">Ticker</div><div class="p-value">${ticker.toUpperCase()}</div></div>
    <div class="panel"><div class="p-title">Broker</div><div class="p-value">${broker.toUpperCase()}</div></div>
    <div class="panel">
      <div class="p-title">Bid / Offer</div>
      <div class="p-value">${ratio.toFixed(2)}</div>
      <span class="badge ${badge}">${label}</span>
    </div>
    <div class="panel"><div class="p-title">Tick Size</div><div class="p-value">${tick}</div></div>
  </div>`;

  document.getElementById('targets').innerHTML = `
  <div class="targets">
    <div class="target low">
      <strong>üü° Target LOW</strong>
      <div class="price">Rp ${targetLow.toFixed(2)}</div>
      <div class="gain">Gain: Rp ${gainLow.toFixed(2)} (${(gainLow/current*100).toFixed(2)}%)</div>
    </div>
    <div class="target high">
      <strong>üü¢ Target HIGH</strong>
      <div class="price">Rp ${targetHigh.toFixed(2)}</div>
      <div class="gain">Gain: Rp ${gainHigh.toFixed(2)} (${(gainHigh/current*100).toFixed(2)}%)</div>
    </div>
  </div>`;

  hitungBandarScore(ticker);
}
</script>
</body>
</html>
